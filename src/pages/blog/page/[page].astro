---
import { getCollection } from "astro:content";
import Layout from "../../../layouts/Layout.astro";
import ArticleCard from "../../../components/ArticleCard.astro";
import Pagination from "../../../components/Pagination.astro";
import { contentfulClient } from "../../../lib/contentful";

const metaData = {
  title: "Blog | Aldrin's Blog",
  description:
    "Read the latest articles and updates on technology and life on Aldrin's Personal Blog.",
};

// In SSR mode, fetch data dynamically
const postsPerPage = 6;
const { page } = Astro.params;
const currentPage = parseInt(page || "1");

// Get local markdown articles
const localArticles = await getCollection("blog");

// Get Contentful articles
const contentfulResponse = await contentfulClient.getEntries({
  content_type: "blog",
  include: 10, // Include linked assets and entries
});

// Transform Contentful entries to match local article structure
const contentfulArticles = contentfulResponse.items.map((item: any) => ({
  slug: item.fields.slug,
  data: {
    title: item.fields.blog_title,
    description: item.fields.description,
    pubDate: item.fields.publishDate,
    tags: item.metadata.tags?.map((tag: any) => tag.sys.id) || [],
    image: item.fields.coverImage?.fields?.file?.url || "",
  },
  // Add a source identifier
  source: "contentful",
  contentfulData: item, // Store original data for future use
}));

// Combine both arrays
const allArticles = [...localArticles, ...contentfulArticles];

// Sort by publish date
const sortedArticles = allArticles.sort((a, b) => {
  return (
    new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime()
  );
});

const totalPages = Math.ceil(sortedArticles.length / postsPerPage);

// Return 404 if page doesn't exist
if (currentPage < 1 || currentPage > totalPages) {
  return Astro.redirect("/404");
}

const start = (currentPage - 1) * postsPerPage;
const end = start + postsPerPage;
const pagePosts = sortedArticles.slice(start, end);
---

<Layout title={metaData.title} description={metaData.description}>
  <main
    class="min-h-screen w-full mx-auto lg:ml-6 my-36 flex flex-col relative md:px-10 gap-5"
  >
    <section class="space-y-3 px-4 lg:px-0">
      <h1 class="text-4xl sm:text-6xl font-bold">Thoughts</h1>
      <p class="text-secondary font-medium mt-4">
        Thoughts on tech, learning, and life.
      </p>
    </section>
    <!-- Blog content  -->
    <div class="mt-4 lg:mt-8 grid grid-cols-1 sm:grid-cols-2 gap-4 lg:gap-8">
      {pagePosts.map((article) => <ArticleCard article={article} />)}
    </div>

    <!-- Pagination  -->
    <Pagination currentPage={currentPage} totalPages={totalPages} />
  </main>
</Layout>
