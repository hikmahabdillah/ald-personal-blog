---
import Layout from "../../layouts/Layout.astro";
import { formatDate } from "../../lib/formatDate";
import { contentfulClient } from "../../lib/contentful";
import { documentToHtmlString } from "@contentful/rich-text-html-renderer";
import { BLOCKS } from "@contentful/rich-text-types";

export async function getStaticPaths() {
  // const posts = await getCollection("blog");
  const posts = await contentfulClient
    .getEntries({
      content_type: "blog",
    })
    .then((response) => response.items);

  return posts.map((post) => ({
    params: {
      slug: post.fields.slug,
    },
    props: {
      post,
    },
  }));
}

const { post } = Astro.props;
const pubDate = formatDate(new Date(post.fields.publishDate as string));
const imageUrl = (post.fields.coverImage as any)?.fields?.file?.url || "";
const imageSrc = imageUrl.startsWith("//") ? `https:${imageUrl}` : imageUrl;

const renderOptions = {
  renderNode: {
    [BLOCKS.EMBEDDED_ASSET]: (node: any) => {
      const { file, title, description } = node.data.target.fields;
      const imageUrl = file.url.startsWith("//")
        ? `https:${file.url}`
        : file.url;
      return `<img src="${imageUrl}" alt="${title || description || "Image"}" class="w-full h-auto rounded-lg my-4" />`;
    },
  },
};

const htmlContent = post.fields.content
  ? documentToHtmlString(post.fields.content as any, renderOptions)
  : "";

const metaData = {
  title: (post?.fields?.blog_title as string) || "Blog Post",
  description: (post?.fields?.description as string) || "",
};
---

<Layout title={metaData.title} description={metaData.description}>
  <article
    class="min-h-screen w-full mx-auto lg:ml-6 my-36 flex flex-col relative md:px-10"
  >
    <section class="space-y-5 px-1">
      <div class="flex justify-between items-center gap-4">
        <ul
          class="ml-2 flex flex-wrap gap-x-5 w-full marker:content-['#'] text-sm lg:text-base text-primary font-medium"
        >
          {
            post.metadata?.tags?.map((tag: any) => (
              <li class="capitalize">{tag.sys.id}</li>
            ))
          }
        </ul>
        <p class="text-nowrap text-sm lg:text-base text-secondary font-medium">
          {pubDate}
        </p>
      </div>

      <div>
        <h1 class="text-3xl sm:text-5xl md:text-6xl font-bold">
          {post.fields.blog_title}
        </h1>
        <p class="text-secondary font-medium mt-5">
          {post.fields.description}
        </p>
      </div>

      <div class="space-y-2 my-10">
        <img
          src={imageSrc}
          alt={post.fields.blog_title as string}
          class="object-contain h-auto w-full rounded-lg md:rounded-xl"
        />
        {
          post.fields.imageCredit && (
            <p class="text-sm md:text-sm text-secondary/70 italic font-medium">
              Source: {post.fields.imageCredit}
            </p>
          )
        }
      </div>
    </section>
    <!-- Blog content  -->
    <section
      class="max-w-none prose prose-slate lg:prose-lg px-1"
      set:html={htmlContent}
    />
  </article>
</Layout>
